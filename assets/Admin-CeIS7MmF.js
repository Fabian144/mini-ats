import{j as e,r as u}from"./vendor-radix-og3wzDO_.js";import{u as W,b as X,c as E}from"./vendor-query-CUB_NE-9.js";import{D as Z,e as F,f as ee,g as P,h as T,i as K,S as ae,a as se,b as te,c as ne,d as L,A as re,j as ie,k as le,l as de,m as oe,n as ce,o as me,p as ue,q as he}from"./select-BBUArvpG.js";import{b as U,c as xe,e as pe,a as fe,u as ge,s as j}from"./index-QOa0XFRL.js";import{c as je}from"./vendor-supabase-6c5mf4pY.js";import{B as i}from"./button-DyABUjjI.js";import{L as h,I as v,U as ve}from"./label-Cqlawg_Y.js";import{C as V,d as z,a as ye,b as be}from"./card-BmOqFtM6.js";import{P as Ne,S as we,T as Ae}from"./trash-2-CwsJwkR9.js";import"./vendor-react-DChhcE8F.js";import"./briefcase-DaCKP-EU.js";import"./vendor-recharts-qYF2F-lo.js";const R=U("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);const Se=U("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]);const Ce=U("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),_e="https://njrsfznxiouhzsgopzqp.supabase.co",ke="sb_publishable_HeAPlBvhL7AA6a5PzJaq9Q_clH0PONf",De=je(_e,ke,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1,storage:{getItem:()=>null,setItem:()=>{},removeItem:()=>{}}},global:{headers:{"x-client-info":"mini-ats"}},db:{schema:"public"}}),Ee=pe("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function Ue({className:d,variant:r,...x}){return e.jsx("div",{className:xe(Ee({variant:r}),d),...x})}function Me(){const{toast:d}=fe(),{user:r,isAdmin:x,signOut:B,adminViewAccount:p,setAdminViewAccount:b}=ge(),N=W(),[H,w]=u.useState(!1),[M,f]=u.useState(!1),[y,A]=u.useState(null),[m,S]=u.useState({fullName:"",email:""}),[O,I]=u.useState(null),[l,g]=u.useState({email:"",password:"",fullName:"",role:"customer"}),{data:C=[],isLoading:Q}=X({queryKey:["admin-users"],queryFn:async()=>{const[a,s]=await Promise.all([j.rpc("admin_list_users"),j.from("user_roles").select("user_id, role")]);if(a.error)throw console.error("admin_list_users error:",a.error),a.error;if(s.error)throw console.error("user_roles error:",s.error),s.error;const n=new Map;for(const t of s.data)n.set(t.user_id,t.role);return a.data.map(t=>({id:t.id,email:t.email,display_name:t.display_name,role:n.get(t.id)??"customer"}))},staleTime:1e3*60*2}),_=E({mutationFn:async({email:a,password:s,fullName:n,role:t})=>{const{data:o,error:c}=await De.auth.signUp({email:a,password:s,options:{data:{display_name:n,role:t}}});if(c)throw c;if(!o.user)throw new Error("Användare skapades inte");return o},onSuccess:()=>{N.invalidateQueries({queryKey:["admin-users"]}),d({title:"Användare skapad!"}),w(!1),g({email:"",password:"",fullName:"",role:"customer"})},onError:a=>{d({title:"Kunde inte skapa användare",description:a.message,variant:"destructive"})}}),k=E({mutationFn:async({userId:a,email:s,fullName:n})=>{const t=s.trim()||null,o=n.trim()||null,{error:c}=await j.rpc("admin_update_customer_identity",{_user_id:a,_email:t,_display_name:o});if(c)throw c},onSuccess:()=>{N.invalidateQueries({queryKey:["admin-users"]}),d({title:"Kontot uppdaterat."}),f(!1),A(null)},onError:a=>{d({title:"Kunde inte uppdatera konto",description:a.message,variant:"destructive"})}}),q=E({mutationFn:async a=>{const s=r?.id===a,{error:n}=s?await j.rpc("delete_own_account"):await j.rpc("delete_user",{_user_id:a});if(n)throw n;s&&await B()},onMutate:a=>{I(a)},onSuccess:(a,s)=>{N.invalidateQueries({queryKey:["admin-users"]}),p?.id===s&&r?.id!==s&&b(null),d({title:"Konto borttaget."})},onError:a=>{d({title:"Kunde inte ta bort konto",description:a.message,variant:"destructive"})},onSettled:()=>{I(null)}}),J=a=>{a.preventDefault(),_.mutate(l)},Y=a=>{if(a.preventDefault(),!y)return;const s=m.fullName.trim(),n=m.email.trim(),t=s!==(y.display_name??""),o=n!==y.email;if(!t&&!o){f(!1),A(null);return}k.mutate({userId:y.id,email:n,fullName:s})},D=[...C].sort((a,s)=>{const n=r?.id,t=a.id===n,o=s.id===n;if(t!==o)return t?-1:1;const c=a.role==="admin",G=s.role==="admin";return c!==G?c?-1:1:a.email.localeCompare(s.email)}),$=C.filter(a=>a.role==="admin").length;return e.jsxs(Z,{children:[e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Administration"}),e.jsx("p",{className:"text-muted-foreground",children:"Hantera användare och behörigheter"})]}),e.jsxs(F,{open:H,onOpenChange:w,children:[e.jsx(ee,{asChild:!0,children:e.jsxs(i,{children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"Skapa användare"]})}),e.jsxs(P,{children:[e.jsx(T,{children:e.jsx(K,{children:"Skapa ny användare"})}),e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{htmlFor:"fullName",children:["Fullständigt namn ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{id:"fullName",value:l.fullName,onChange:a=>g({...l,fullName:a.target.value}),placeholder:"Anna Andersson",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{htmlFor:"email",children:["E-post ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{id:"email",type:"email",value:l.email,onChange:a=>g({...l,email:a.target.value}),placeholder:"anna@email.se",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{htmlFor:"password",children:["Lösenord ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{id:"password",type:"password",value:l.password,onChange:a=>g({...l,password:a.target.value}),placeholder:"Minst 6 tecken",required:!0,minLength:6})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"role",children:"Roll"}),e.jsxs(ae,{value:l.role,onValueChange:a=>g({...l,role:a}),children:[e.jsx(se,{children:e.jsx(te,{})}),e.jsxs(ne,{children:[e.jsx(L,{value:"customer",children:"Kund"}),e.jsx(L,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>w(!1),children:"Avbryt"}),e.jsx(i,{type:"submit",disabled:_.isPending,children:_.isPending?"Skapar...":"Skapa användare"})]})]})]})]})]}),Q?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"Laddar..."}):C.length===0?e.jsx(V,{className:"text-center py-12",children:e.jsxs(z,{children:[e.jsx(ve,{className:"w-12 h-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"font-medium text-lg mb-2",children:"Inga användare ännu"}),e.jsx("p",{className:"text-muted-foreground",children:"Skapa den första användaren"})]})}):e.jsx("div",{className:`w-full ${D.length===2?"max-w-[1100px]":D.length===1?"max-w-[550px]":"max-w-[1900px]"}`,children:e.jsx("div",{className:"grid gap-2 [grid-template-columns:repeat(auto-fit,minmax(min(100%,28em),1fr))]",children:D.map(a=>e.jsxs(V,{className:"w-full min-w-0",children:[e.jsx(ye,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:a.role==="admin"?e.jsx(Se,{className:"w-5 h-5 text-primary"}):e.jsx(Ce,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs(be,{className:"text-base truncate",children:[a.display_name||"Namnlös",a.id===r?.id?" (Du)":""]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:a.email})]})]}),x?e.jsxs("div",{className:"flex gap-1",children:[a.role==="customer"?e.jsx(i,{type:"button",variant:"ghost",size:"icon",onClick:()=>{A(a),S({fullName:a.display_name??"",email:a.email}),f(!0)},children:e.jsx(we,{className:"w-4 h-4"})}):null,e.jsxs(re,{children:[e.jsx(ie,{asChild:!0,children:e.jsx(i,{type:"button",variant:"ghost",size:"icon",className:"text-destructive hover:text-destructive",disabled:q.isPending&&O===a.id||a.role==="admin"&&$===1,children:e.jsx(Ae,{className:"w-4 h-4"})})}),e.jsxs(le,{children:[e.jsxs(de,{children:[e.jsx(oe,{children:"Ta bort konto?"}),e.jsx(ce,{children:"Detta tar bort kontot och all tillhörande data. Åtgärden går inte att ångra."})]}),e.jsxs(me,{children:[e.jsx(ue,{asChild:!0,children:e.jsx(i,{type:"button",variant:"outline",children:"Avbryt"})}),e.jsx(he,{asChild:!0,children:e.jsx(i,{type:"button",variant:"destructive",onClick:()=>q.mutate(a.id),children:"Ta bort"})})]})]})]})]}):null]})}),e.jsx(z,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ue,{variant:a.role==="admin"?"default":"secondary",className:"pointer-events-none",children:a.role==="admin"?"Admin":"Kund"}),a.role==="admin"&&x&&e.jsxs(i,{type:"button",variant:a.id===r?.id&&!p?"default":"outline",size:"sm",className:"w-full justify-between",disabled:a.id!==r?.id,onClick:()=>{a.id===r?.id&&b(null)},children:[a.id!==r?.id?"Visa konto":a.id===r?.id&&!p?"Visar alla konton":"Visa alla konton",e.jsx(R,{className:"w-4 h-4"})]}),a.role==="customer"&&x&&e.jsxs(i,{type:"button",variant:p?.id===a.id?"default":"outline",size:"sm",className:"w-full justify-between",onClick:()=>{b({id:a.id,email:a.email,fullName:a.display_name})},children:[p?.id===a.id?"Visar detta konto":"Visa konto",e.jsx(R,{className:"w-4 h-4"})]})]})})]},a.id))})})]}),e.jsx(F,{open:M,onOpenChange:f,children:e.jsxs(P,{children:[e.jsx(T,{children:e.jsx(K,{children:"Redigera kundkonto"})}),e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"edit-full-name",children:"Fullständigt namn"}),e.jsx(v,{id:"edit-full-name",value:m.fullName,onChange:a=>S({...m,fullName:a.target.value}),placeholder:"Anna Andersson",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"edit-email",children:"E-post"}),e.jsx(v,{id:"edit-email",type:"email",value:m.email,onChange:a=>S({...m,email:a.target.value}),placeholder:"anna@email.se",required:!0})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>f(!1),children:"Avbryt"}),e.jsx(i,{type:"submit",disabled:k.isPending,children:k.isPending?"Sparar...":"Spara"})]})]})]})})]})}export{Me as default};
