import{j as e,r as y}from"./vendor-radix-DY4qudGL.js";import{u as F,b as K,c as S}from"./vendor-query-CH72qb2W.js";import{D as B,S as H,a as M,b as R,c as O,d as k,A as Q,e as J,f as Y,g as G,h as W,i as X,j as Z,k as $,l as ee}from"./select-D7EeeO1m.js";import{b as N,c as ae,e as se,a as te,u as re,s as x}from"./index-mAFw_Uzw.js";import{c as ne}from"./vendor-supabase-6c5mf4pY.js";import{B as l,I as b,U as ie}from"./input-h_5tXWFu.js";import{L as p,C as _,d as D,a as le,b as oe}from"./card-BUn8DwcO.js";import{D as de,a as ce,P as me,b as ue,c as he,d as xe,T as pe}from"./dialog-D-8J6b1g.js";import"./vendor-react-EpQGxqdE.js";import"./briefcase-RTyYyln2.js";import"./vendor-recharts-zFAyUZWb.js";const U=N("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);const fe=N("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]);const ge=N("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),je="https://njrsfznxiouhzsgopzqp.supabase.co",ve="sb_publishable_HeAPlBvhL7AA6a5PzJaq9Q_clH0PONf",ye=ne(je,ve,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1,storage:{getItem:()=>null,setItem:()=>{},removeItem:()=>{}}},global:{headers:{"x-client-info":"mini-ats"}},db:{schema:"public"}}),be=se("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function Ne({className:o,variant:r,...d}){return e.jsx("div",{className:ae(be({variant:r}),o),...d})}function Pe(){const{toast:o}=te(),{user:r,isAdmin:d,signOut:I,adminViewAccount:c,setAdminViewAccount:f}=re(),w=F(),[T,g]=y.useState(!1),[L,A]=y.useState(null),[i,m]=y.useState({email:"",password:"",fullName:"",role:"customer"}),{data:j=[],isLoading:P}=K({queryKey:["admin-users"],queryFn:async()=>{const[a,s]=await Promise.all([x.from("profiles").select("user_id, email, full_name"),x.from("user_roles").select("user_id, role")]);if(a.error)throw a.error;if(s.error)throw s.error;const n=new Map;for(const t of s.data)n.set(t.user_id,t.role);return a.data.map(t=>({id:t.user_id,email:t.email,full_name:t.full_name,role:n.get(t.user_id)??"customer"}))},staleTime:1e3*60*2}),v=S({mutationFn:async({email:a,password:s,fullName:n,role:t})=>{const{data:h,error:u}=await ye.auth.signUp({email:a,password:s,options:{data:{full_name:n,role:t}}});if(u)throw u;if(!h.user)throw new Error("Användare skapades inte");return h},onSuccess:()=>{w.invalidateQueries({queryKey:["admin-users"]}),o({title:"Användare skapad!"}),g(!1),m({email:"",password:"",fullName:"",role:"customer"})},onError:a=>{o({title:"Kunde inte skapa användare",description:a.message,variant:"destructive"})}}),C=S({mutationFn:async a=>{const s=r?.id===a,{error:n}=s?await x.rpc("delete_own_account"):await x.rpc("delete_user",{_user_id:a});if(n)throw n;s&&await I()},onMutate:a=>{A(a)},onSuccess:(a,s)=>{w.invalidateQueries({queryKey:["admin-users"]}),c?.id===s&&r?.id!==s&&f(null),o({title:"Konto borttaget."})},onError:a=>{o({title:"Kunde inte ta bort konto",description:a.message,variant:"destructive"})},onSettled:()=>{A(null)}}),V=a=>{a.preventDefault(),v.mutate(i)},q=[...j].sort((a,s)=>{const n=r?.id,t=a.id===n,h=s.id===n;if(t!==h)return t?-1:1;const u=a.role==="admin",z=s.role==="admin";return u!==z?u?-1:1:a.email.localeCompare(s.email)}),E=j.filter(a=>a.role==="admin").length;return e.jsx(B,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Administration"}),e.jsx("p",{className:"text-muted-foreground",children:"Hantera användare och behörigheter"})]}),e.jsxs(de,{open:T,onOpenChange:g,children:[e.jsx(ce,{asChild:!0,children:e.jsxs(l,{children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"Skapa användare"]})}),e.jsxs(ue,{children:[e.jsx(he,{children:e.jsx(xe,{children:"Skapa ny användare"})}),e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{htmlFor:"fullName",children:["Fullständigt namn ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{id:"fullName",value:i.fullName,onChange:a=>m({...i,fullName:a.target.value}),placeholder:"Anna Andersson",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{htmlFor:"email",children:["E-post ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{id:"email",type:"email",value:i.email,onChange:a=>m({...i,email:a.target.value}),placeholder:"anna@email.se",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{htmlFor:"password",children:["Lösenord ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(b,{id:"password",type:"password",value:i.password,onChange:a=>m({...i,password:a.target.value}),placeholder:"Minst 6 tecken",required:!0,minLength:6})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"role",children:"Roll"}),e.jsxs(H,{value:i.role,onValueChange:a=>m({...i,role:a}),children:[e.jsx(M,{children:e.jsx(R,{})}),e.jsxs(O,{children:[e.jsx(k,{value:"customer",children:"Kund"}),e.jsx(k,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>g(!1),children:"Avbryt"}),e.jsx(l,{type:"submit",disabled:v.isPending,children:v.isPending?"Skapar...":"Skapa användare"})]})]})]})]})]}),P?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"Laddar..."}):j.length===0?e.jsx(_,{className:"text-center py-12",children:e.jsxs(D,{children:[e.jsx(ie,{className:"w-12 h-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"font-medium text-lg mb-2",children:"Inga användare ännu"}),e.jsx("p",{className:"text-muted-foreground",children:"Skapa den första användaren"})]})}):e.jsx("div",{className:"grid gap-2 [grid-template-columns:repeat(auto-fit,minmax(min(100%,25em),1fr))]",children:q.map(a=>e.jsxs(_,{className:"w-full min-w-0",children:[e.jsx(le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:a.role==="admin"?e.jsx(fe,{className:"w-5 h-5 text-primary"}):e.jsx(ge,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs(oe,{className:"text-base truncate",children:[a.full_name||"Namnlös",a.id===r?.id?" (Du)":""]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:a.email})]})]}),d?e.jsxs(Q,{children:[e.jsx(J,{asChild:!0,children:e.jsx(l,{type:"button",size:"sm",variant:"destructive",className:"whitespace-nowrap",disabled:C.isPending&&L===a.id||a.role==="admin"&&E===1,children:e.jsx(pe,{className:"w-4 h-4"})})}),e.jsxs(Y,{children:[e.jsxs(G,{children:[e.jsx(W,{children:"Ta bort konto?"}),e.jsx(X,{children:"Detta tar bort kontot och all tillhörande data. Åtgärden går inte att ångra."})]}),e.jsxs(Z,{children:[e.jsx($,{asChild:!0,children:e.jsx(l,{type:"button",variant:"outline",children:"Avbryt"})}),e.jsx(ee,{asChild:!0,children:e.jsx(l,{type:"button",variant:"destructive",onClick:()=>C.mutate(a.id),children:"Ta bort"})})]})]})]}):null]})}),e.jsx(D,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ne,{variant:a.role==="admin"?"default":"secondary",className:"pointer-events-none",children:a.role==="admin"?"Admin":"Kund"}),a.role==="admin"&&d&&e.jsxs(l,{type:"button",variant:a.id===r?.id&&!c?"default":"outline",size:"sm",className:"w-full justify-between",disabled:a.id!==r?.id,onClick:()=>{a.id===r?.id&&f(null)},children:[a.id!==r?.id?"Visa konto":a.id===r?.id&&!c?"Visar alla konton":"Visa alla konton",e.jsx(U,{className:"w-4 h-4"})]}),a.role==="customer"&&d&&e.jsxs(l,{type:"button",variant:c?.id===a.id?"default":"outline",size:"sm",className:"w-full justify-between",onClick:()=>{f({id:a.id,email:a.email,fullName:a.full_name})},children:[c?.id===a.id?"Visar detta konto":"Visa konto",e.jsx(U,{className:"w-4 h-4"})]})]})})]},a.id))})]})})}export{Pe as default};
